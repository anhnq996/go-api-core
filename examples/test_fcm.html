<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FCM Test - ApiCore</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      h1 {
        color: #333;
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      h2 {
        color: #555;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
        margin-top: 30px;
      }

      .status-card {
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .status-warning {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .status-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      .input-group {
        margin: 20px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      .input-group input,
      .input-group textarea,
      .input-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus,
      .input-group textarea:focus,
      .input-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .input-group textarea {
        min-height: 100px;
        resize: vertical;
        font-family: monospace;
      }

      .token-display {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
        position: relative;
        margin: 10px 0;
      }

      .token-display::before {
        content: "FCM Token:";
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #667eea;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        margin: 5px;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-copy {
        background: #17a2b8;
        padding: 8px 16px;
        font-size: 12px;
        margin-top: 10px;
      }

      .notifications-log {
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
        margin: 20px 0;
      }

      .notification-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .notification-item .time {
        color: #999;
        font-size: 12px;
        margin-bottom: 8px;
      }

      .notification-item .title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .notification-item .body {
        color: #666;
        margin-bottom: 5px;
      }

      .notification-item .data {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        margin-top: 10px;
        word-break: break-all;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
      }

      .card h3 {
        margin-top: 0;
        color: #667eea;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin: 2px;
      }

      .badge-success {
        background: #d4edda;
        color: #155724;
      }

      .badge-error {
        background: #f8d7da;
        color: #721c24;
      }

      .badge-info {
        background: #d1ecf1;
        color: #0c5460;
      }

      .firebase-config {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 2px dashed #ccc;
        margin: 15px 0;
      }

      .firebase-config code {
        font-family: monospace;
        font-size: 12px;
        color: #333;
      }

      .instructions {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
        margin: 20px 0;
      }

      .instructions ol {
        margin: 10px 0;
        padding-left: 20px;
      }

      .instructions li {
        margin: 8px 0;
      }

      .clear-btn {
        float: right;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }

        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üî• FCM Test - ApiCore</h1>

      <!-- Firebase Configuration -->
      <div class="firebase-config">
        <strong>üìã Firebase Config:</strong>
        <div class="input-group">
          <label for="firebaseConfig">Firebase Web App Config (JSON):</label>
          <textarea
            id="firebaseConfig"
            placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'
          >
{
  "apiKey": "AIzaSyASJbpleMfK4LC6hGIhcJC0ng1GtkFi4yY",
  "authDomain": "api--core.firebaseapp.com",
  "projectId": "api--core",
  "storageBucket": "api--core.firebasestorage.app",
  "messagingSenderId": "295353376871",
  "appId": "1:295353376871:web:7f837bad391e4278bc34c2",
  "measurementId": "G-4MT0VSYBFW"
}</textarea
          >
          <small style="color: #666">
            L·∫•y t·ª´ Firebase Console > Project Settings > General > Your apps >
            Web app config
          </small>
        </div>
        <button onclick="initializeFirebase()">Kh·ªüi T·∫°o Firebase</button>
      </div>

      <!-- Status -->
      <div id="status" class="status-card status-info">
        <span>‚è≥ Ch∆∞a kh·ªüi t·∫°o Firebase</span>
      </div>

      <!-- Firebase Token Section -->
      <h2>üîë Firebase Token</h2>
      <div class="card">
        <div class="input-group">
          <button onclick="requestPermission()" id="requestBtn" disabled>
            Y√™u C·∫ßu Quy·ªÅn Notification
          </button>
          <button onclick="getToken()" id="getTokenBtn" disabled>
            L·∫•y FCM Token
          </button>
          <button onclick="deleteToken()" id="deleteTokenBtn" disabled>
            X√≥a Token
          </button>
        </div>

        <div id="tokenContainer" style="display: none">
          <div class="token-display" id="tokenDisplay"></div>
          <button class="btn-copy" onclick="copyToken()">üìã Copy Token</button>
          <div style="margin-top: 15px">
            <strong>Token Info:</strong>
            <div id="tokenInfo"></div>
          </div>
        </div>
      </div>

      <!-- Test Notification Section -->
      <h2>üß™ Test Notification</h2>
      <div class="grid">
        <div class="card">
          <h3>G·ª≠i T·ª´ Backend</h3>
          <div class="input-group">
            <label for="backendUrl">Backend URL:</label>
            <input
              type="text"
              id="backendUrl"
              value="http://localhost:3000"
              placeholder="http://localhost:3000"
            />
          </div>
          <div class="input-group">
            <label for="testToken">
              FCM Token:
              <small style="font-weight: normal; color: #666">
                (ƒê·ªÉ tr·ªëng ƒë·ªÉ d√πng token t·ª´ browser)
              </small>
            </label>
            <div style="display: flex; gap: 5px">
              <input
                type="text"
                id="testToken"
                placeholder="Nh·∫≠p FCM token ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ d√πng token hi·ªán t·∫°i"
                style="flex: 1"
              />
              <button
                type="button"
                onclick="copyCurrentTokenToTest()"
                class="btn-copy"
                style="margin: 0"
                id="copyTokenBtn"
                disabled
              >
                üìã D√πng Token Hi·ªán T·∫°i
              </button>
            </div>
          </div>
          <div class="input-group">
            <label for="testTitle">Ti√™u ƒê·ªÅ:</label>
            <input
              type="text"
              id="testTitle"
              value="Test Notification"
              placeholder="Ti√™u ƒë·ªÅ notification"
            />
          </div>
          <div class="input-group">
            <label for="testBody">N·ªôi Dung:</label>
            <textarea id="testBody" placeholder="N·ªôi dung notification">
ƒê√¢y l√† notification test t·ª´ FCM!</textarea
            >
          </div>
          <div class="input-group">
            <label for="testData">
              Data (Key-Value Pairs):
              <small
                style="
                  font-weight: normal;
                  color: #666;
                  display: block;
                  margin-top: 5px;
                "
              >
                M·ªói d√≤ng m·ªôt c·∫∑p <code>key=value</code>. D√≤ng b·∫Øt ƒë·∫ßu b·∫±ng
                <code>#</code> l√† comment.<br />
                <strong>V√≠ d·ª•:</strong><br />
                <code
                  style="
                    background: #f0f0f0;
                    padding: 2px 4px;
                    border-radius: 3px;
                  "
                >
                  action=open_app<br />
                  screen=home<br />
                  user_id=12345<br />
                  deep_link=https://example.com/product?id=123
                </code>
              </small>
            </label>
            <textarea
              id="testData"
              placeholder="action=open_app&#10;screen=home&#10;user_id=12345"
              style="min-height: 100px; font-family: monospace; font-size: 12px"
            ></textarea>
          </div>
          <button onclick="sendTestNotification()" id="sendTestBtn" disabled>
            G·ª≠i Test Notification
          </button>
          <div id="sendResult" style="margin-top: 10px"></div>
        </div>

        <div class="card">
          <h3>Subscribe Topic</h3>
          <div class="input-group">
            <label for="topicName">Topic Name:</label>
            <input
              type="text"
              id="topicName"
              value="test_topic"
              placeholder="test_topic"
            />
          </div>
          <button onclick="subscribeToTopic()" id="subscribeBtn" disabled>
            Subscribe Topic
          </button>
          <button onclick="unsubscribeFromTopic()" id="unsubscribeBtn" disabled>
            Unsubscribe Topic
          </button>
          <div id="topicResult" style="margin-top: 10px"></div>
        </div>
      </div>

      <!-- Notifications Log -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h2>üì¨ Notifications Received</h2>
        <button class="btn-secondary clear-btn" onclick="clearNotifications()">
          X√≥a T·∫•t C·∫£
        </button>
      </div>
      <div class="notifications-log" id="notificationsLog">
        <div style="text-align: center; color: #999; padding: 20px">
          Ch∆∞a c√≥ notification n√†o...
        </div>
      </div>

      <!-- Instructions -->
      <div class="instructions">
        <h3>üìñ H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng</h3>
        <ol>
          <li>
            <strong>L·∫•y Firebase Config:</strong> Truy c·∫≠p Firebase Console >
            Project Settings > General > Your apps > Web app > Config
          </li>
          <li>
            <strong>Paste config v√†o √¥ tr√™n</strong> v√† click "Kh·ªüi T·∫°o
            Firebase"
          </li>
          <li><strong>Y√™u c·∫ßu quy·ªÅn notification</strong> t·ª´ browser</li>
          <li>
            <strong>L·∫•y FCM token</strong> v√† copy token ƒë·ªÉ d√πng cho backend
          </li>
          <li>
            <strong>Test notification:</strong> S·ª≠ d·ª•ng token ƒë·ªÉ g·ª≠i
            notification t·ª´ backend ho·∫∑c subscribe v√†o topic
          </li>
        </ol>
        <p>
          <strong>L∆∞u √Ω:</strong> ƒê·ªÉ nh·∫≠n notification khi tab ƒëang m·ªü, c·∫ßn c·∫•u
          h√¨nh Service Worker. Xem file <code>firebase-messaging-sw.js</code>
        </p>
      </div>
    </div>

    <script>
      let messaging = null;
      let currentToken = null;
      let notificationCount = 0;

      // Update status
      function updateStatus(message, type = "info") {
        const statusDiv = document.getElementById("status");
        statusDiv.className = `status-card status-${type}`;
        statusDiv.innerHTML = `<span>${message}</span>`;
      }

      // Initialize Firebase
      function initializeFirebase() {
        const configText = document
          .getElementById("firebaseConfig")
          .value.trim();
        if (!configText) {
          alert("Vui l√≤ng nh·∫≠p Firebase config!");
          return;
        }

        try {
          const firebaseConfig = JSON.parse(configText);

          // Initialize Firebase
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }

          // Initialize Firebase Cloud Messaging
          messaging = firebase.messaging();

          // Enable buttons
          document.getElementById("requestBtn").disabled = false;

          // Request permission on initialization
          requestPermission();

          updateStatus("‚úÖ Firebase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng!", "success");
        } catch (error) {
          updateStatus(`‚ùå L·ªói kh·ªüi t·∫°o Firebase: ${error.message}`, "error");
          console.error("Firebase initialization error:", error);
        }
      }

      // Request notification permission
      async function requestPermission() {
        if (!messaging) {
          alert("Vui l√≤ng kh·ªüi t·∫°o Firebase tr∆∞·ªõc!");
          return;
        }

        try {
          const permission = await Notification.requestPermission();
          if (permission === "granted") {
            updateStatus("‚úÖ Quy·ªÅn notification ƒë√£ ƒë∆∞·ª£c c·∫•p!", "success");
            document.getElementById("getTokenBtn").disabled = false;
            document.getElementById("subscribeBtn").disabled = false;
            document.getElementById("unsubscribeBtn").disabled = false;
            // Auto get token
            getToken();
          } else {
            updateStatus("‚ùå Quy·ªÅn notification b·ªã t·ª´ ch·ªëi!", "error");
          }
        } catch (error) {
          updateStatus(`‚ùå L·ªói khi y√™u c·∫ßu quy·ªÅn: ${error.message}`, "error");
          console.error("Permission error:", error);
        }
      }

      // Get FCM token
      async function getToken() {
        if (!messaging) {
          alert("Vui l√≤ng kh·ªüi t·∫°o Firebase tr∆∞·ªõc!");
          return;
        }

        try {
          currentToken = await messaging.getToken({
            vapidKey: getVapidKey(), // Optional: if you have VAPID key
          });

          if (currentToken) {
            document.getElementById("tokenDisplay").textContent = currentToken;
            document.getElementById("tokenContainer").style.display = "block";
            document.getElementById("sendTestBtn").disabled = false;

            // Show token info
            const tokenInfo = document.getElementById("tokenInfo");
            tokenInfo.innerHTML = `
              <div class="badge badge-success">Token h·ª£p l·ªá</div>
              <div style="margin-top: 10px;">
                <strong>ƒê·ªô d√†i:</strong> ${currentToken.length} k√Ω t·ª±<br>
                <strong>L·∫•y l√∫c:</strong> ${new Date().toLocaleString("vi-VN")}
              </div>
            `;

            updateStatus("‚úÖ ƒê√£ l·∫•y FCM token th√†nh c√¥ng!", "success");

            // Enable copy token button
            document.getElementById("copyTokenBtn").disabled = false;

            // Setup message listener
            setupMessageListener();
          } else {
            updateStatus(
              "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y token. Ki·ªÉm tra quy·ªÅn notification.",
              "warning"
            );
          }
        } catch (error) {
          updateStatus(`‚ùå L·ªói khi l·∫•y token: ${error.message}`, "error");
          console.error("Token error:", error);
        }
      }

      // Delete token
      async function deleteToken() {
        if (!messaging || !currentToken) {
          alert("Kh√¥ng c√≥ token ƒë·ªÉ x√≥a!");
          return;
        }

        try {
          await messaging.deleteToken();
          currentToken = null;
          document.getElementById("tokenContainer").style.display = "none";
          document.getElementById("sendTestBtn").disabled = true;
          updateStatus("‚úÖ ƒê√£ x√≥a token th√†nh c√¥ng!", "success");
        } catch (error) {
          updateStatus(`‚ùå L·ªói khi x√≥a token: ${error.message}`, "error");
          console.error("Delete token error:", error);
        }
      }

      // Copy token to clipboard
      function copyToken() {
        if (!currentToken) {
          alert("Kh√¥ng c√≥ token ƒë·ªÉ copy!");
          return;
        }

        navigator.clipboard.writeText(currentToken).then(
          () => {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "‚úÖ ƒê√£ copy!";
            setTimeout(() => {
              btn.textContent = originalText;
            }, 2000);
          },
          (err) => {
            alert("L·ªói khi copy: " + err);
          }
        );
      }

      // Setup message listener
      function setupMessageListener() {
        if (!messaging) return;

        // Handle foreground messages
        messaging.onMessage((payload) => {
          console.log("Message received:", payload);
          addNotification(payload);
          showBrowserNotification(payload);
        });
      }

      // Add notification to log
      function addNotification(payload) {
        notificationCount++;
        const log = document.getElementById("notificationsLog");

        // Clear placeholder
        if (notificationCount === 1) {
          log.innerHTML = "";
        }

        const notificationDiv = document.createElement("div");
        notificationDiv.className = "notification-item";

        const time = new Date().toLocaleString("vi-VN");
        const title = payload.notification?.title || "No title";
        const body = payload.notification?.body || "No body";
        const data = payload.data || {};

        notificationDiv.innerHTML = `
          <div class="time">${time}</div>
          <div class="title">${title}</div>
          <div class="body">${body}</div>
          ${
            Object.keys(data).length > 0
              ? `<div class="data">Data: ${JSON.stringify(data, null, 2)}</div>`
              : ""
          }
          ${
            payload.data
              ? `<div class="data">Raw Data: ${JSON.stringify(
                  payload.data,
                  null,
                  2
                )}</div>`
              : ""
          }
        `;

        log.appendChild(notificationDiv);
        log.scrollTop = log.scrollHeight;
      }

      // Show browser notification
      function showBrowserNotification(payload) {
        if (Notification.permission === "granted") {
          const notification = new Notification(
            payload.notification?.title || "New Notification",
            {
              body: payload.notification?.body || "You have a new notification",
              icon: payload.notification?.icon || "/favicon.ico",
              badge: "/favicon.ico",
              tag: payload.data?.tag || "fcm-notification",
              data: payload.data,
            }
          );

          notification.onclick = () => {
            window.focus();
            notification.close();
          };
        }
      }

      // Parse key-value pairs from textarea
      // Format: key=value (m·ªói d√≤ng m·ªôt c·∫∑p)
      // H·ªó tr·ª£ value c√≥ ch·ª©a d·∫•u = b·∫±ng c√°ch ch·ªâ split ·ªü d·∫•u = ƒë·∫ßu ti√™n
      function parseKeyValuePairs(text) {
        const data = {};
        if (!text || !text.trim()) {
          return data;
        }

        const lines = text.split("\n");
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();

          // Skip empty lines and comments (lines starting with #)
          if (!line || line.startsWith("#")) {
            continue;
          }

          // Find first = sign
          const separatorIndex = line.indexOf("=");
          if (separatorIndex === -1 || separatorIndex === 0) {
            // Invalid format (no = or = at start), skip this line
            console.warn(`Skipping invalid line ${i + 1}: ${line}`);
            continue;
          }

          const key = line.substring(0, separatorIndex).trim();
          const value = line.substring(separatorIndex + 1).trim();

          if (key) {
            data[key] = value || ""; // Allow empty values
          } else {
            console.warn(`Skipping line ${i + 1} with empty key: ${line}`);
          }
        }

        return data;
      }

      // Copy current token to test token input
      function copyCurrentTokenToTest() {
        if (!currentToken) {
          alert("Ch∆∞a c√≥ token! Vui l√≤ng l·∫•y token tr∆∞·ªõc.");
          return;
        }
        document.getElementById("testToken").value = currentToken;
      }

      // Send test notification from backend
      async function sendTestNotification() {
        const backendUrl = document.getElementById("backendUrl").value;
        const title = document.getElementById("testTitle").value;
        const body = document.getElementById("testBody").value;
        const dataText = document.getElementById("testData").value;
        const testToken = document.getElementById("testToken").value.trim();

        if (!backendUrl || !title || !body) {
          alert(
            "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin (Backend URL, Ti√™u ƒë·ªÅ, N·ªôi dung)!"
          );
          return;
        }

        // Get token: use input token if provided, otherwise use current token
        let token = testToken || currentToken;
        if (!token) {
          alert("Vui l√≤ng nh·∫≠p FCM token ho·∫∑c l·∫•y token t·ª´ browser tr∆∞·ªõc!");
          return;
        }

        // Parse key-value pairs from textarea
        const data = parseKeyValuePairs(dataText);

        // Always add type and timestamp to data
        data.timestamp = new Date().toISOString();

        const resultDiv = document.getElementById("sendResult");
        resultDiv.innerHTML =
          '<span class="badge badge-info">ƒêang g·ª≠i...</span>';

        try {
          const response = await fetch(`${backendUrl}/test/fcm/test`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              token: token,
              title: title,
              body: body,
              data: data,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `
              <span class="badge badge-success">‚úÖ G·ª≠i th√†nh c√¥ng!</span>
              <div style="margin-top: 5px; font-size: 12px;">
                Message ID: ${result.message_id || result.id || "N/A"}
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <span class="badge badge-error">‚ùå L·ªói: ${
                result.message || result.error || "Unknown error"
              }</span>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <span class="badge badge-error">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>
            <div style="margin-top: 5px; font-size: 12px; color: #666;">
              L∆∞u √Ω: B·∫°n c·∫ßn t·∫°o API endpoint /test/fcm/test trong backend
            </div>
          `;
          console.error("Send notification error:", error);
        }
      }

      // Subscribe to topic
      async function subscribeToTopic() {
        if (!currentToken) {
          alert("Vui l√≤ng l·∫•y token tr∆∞·ªõc!");
          return;
        }

        const topic = document.getElementById("topicName").value.trim();
        if (!topic) {
          alert("Vui l√≤ng nh·∫≠p t√™n topic!");
          return;
        }

        const resultDiv = document.getElementById("topicResult");
        resultDiv.innerHTML =
          '<span class="badge badge-info">ƒêang subscribe...</span>';

        try {
          // Note: C·∫ßn c√≥ backend endpoint ƒë·ªÉ subscribe topic
          const backendUrl = document.getElementById("backendUrl").value;
          const response = await fetch(`${backendUrl}/test/fcm/subscribe`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              tokens: [currentToken],
              topic: topic,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `
              <span class="badge badge-success">‚úÖ ƒê√£ subscribe topic: ${topic}</span>
            `;
          } else {
            resultDiv.innerHTML = `
              <span class="badge badge-error">‚ùå L·ªói: ${
                result.message || result.error
              }</span>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <span class="badge badge-error">‚ùå L·ªói: ${error.message}</span>
          `;
          console.error("Subscribe error:", error);
        }
      }

      // Unsubscribe from topic
      async function unsubscribeFromTopic() {
        if (!currentToken) {
          alert("Vui l√≤ng l·∫•y token tr∆∞·ªõc!");
          return;
        }

        const topic = document.getElementById("topicName").value.trim();
        if (!topic) {
          alert("Vui l√≤ng nh·∫≠p t√™n topic!");
          return;
        }

        const resultDiv = document.getElementById("topicResult");
        resultDiv.innerHTML =
          '<span class="badge badge-info">ƒêang unsubscribe...</span>';

        try {
          const backendUrl = document.getElementById("backendUrl").value;
          const response = await fetch(`${backendUrl}/test/fcm/unsubscribe`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              tokens: [currentToken],
              topic: topic,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `
              <span class="badge badge-success">‚úÖ ƒê√£ unsubscribe topic: ${topic}</span>
            `;
          } else {
            resultDiv.innerHTML = `
              <span class="badge badge-error">‚ùå L·ªói: ${
                result.message || result.error
              }</span>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <span class="badge badge-error">‚ùå L·ªói: ${error.message}</span>
          `;
          console.error("Unsubscribe error:", error);
        }
      }

      // Clear notifications
      function clearNotifications() {
        notificationCount = 0;
        document.getElementById("notificationsLog").innerHTML = `
          <div style="text-align: center; color: #999; padding: 20px;">
            Ch∆∞a c√≥ notification n√†o...
          </div>
        `;
      }

      // Get VAPID key (optional, for custom VAPID)
      function getVapidKey() {
        // B·∫°n c√≥ th·ªÉ l·∫•y VAPID key t·ª´ Firebase Console > Project Settings > Cloud Messaging > Web Push certificates
        // Ho·∫∑c ƒë·ªÉ null n·∫øu kh√¥ng d√πng custom VAPID
        return null;
      }

      // Check if service worker is supported
      if ("serviceWorker" in navigator) {
        // Service worker s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông register b·ªüi Firebase SDK
        console.log("Service Worker supported");
      } else {
        updateStatus(
          "‚ö†Ô∏è Service Worker kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n browser n√†y",
          "warning"
        );
      }

      // Auto-initialize Firebase on page load if config is present
      window.addEventListener("DOMContentLoaded", () => {
        const configText = document
          .getElementById("firebaseConfig")
          .value.trim();
        if (configText) {
          // Auto-initialize after a short delay to ensure DOM is ready
          setTimeout(() => {
            console.log("Auto-initializing Firebase with default config...");
            initializeFirebase();
          }, 500);
        }
      });

      // Check notification permission on load
      if (Notification.permission === "granted") {
        updateStatus("‚úÖ Quy·ªÅn notification ƒë√£ ƒë∆∞·ª£c c·∫•p tr∆∞·ªõc ƒë√≥", "success");
      } else if (Notification.permission === "denied") {
        updateStatus("‚ùå Quy·ªÅn notification b·ªã t·ª´ ch·ªëi", "error");
      }
    </script>
  </body>
</html>
